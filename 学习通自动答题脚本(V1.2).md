# 学习通自动答题脚本(V1.2) #

---
## 描述 ##
__此脚本UI界面几乎全部借助AI,仅支持单选,多选题的自动答题,需额外付费 __
* Token获取地址为<a href="https://globalai.vip" target="_blank">这里</a>，如果修改，那么AI选择可能也会随之变少，仅支持修改两种。
* 代码中的提示词建议不要擅自修改
---

```js
// ==UserScript==
// @name         自动答题学习通
// @namespace    https://docs.scriptcat.org/
// @version      0.1.0
// @description  try to take over the world!
// @author       Summit
// @match        *://*.chaoxing.com/mooc-ans/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=chat.deepseek.com
// @grant        GM_addStyle
// @require      https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js
// ==/UserScript==

(function () {
  "use strict";

  // -------------------------- 额外界面功能：拖动+日志展开/收起（内部函数，不污染全局） --------------------------
  function initDrag(panel) {
    const header = panel.querySelector('.answer-helper-header');
    let isDragging = false;
    let startX, startY, panelX, panelY;

    // PC端鼠标拖动
    header.addEventListener('mousedown', (e) => {
      isDragging = true;
      const rect = panel.getBoundingClientRect();
      panelX = rect.left;
      panelY = rect.top;
      startX = e.clientX;
      startY = e.clientY;
      panel.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.2)';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const offsetX = e.clientX - startX;
      const offsetY = e.clientY - startY;
      panel.style.left = `${panelX + offsetX}px`;
      panel.style.top = `${panelY + offsetY}px`;
      panel.style.transform = 'none';
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        panel.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
      }
    });

    // 移动端触摸拖动
    header.addEventListener('touchstart', (e) => {
      if (e.touches.length > 0) {
        isDragging = true;
        const rect = panel.getBoundingClientRect();
        panelX = rect.left;
        panelY = rect.top;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        panel.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.2)';
        e.preventDefault();
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging || e.touches.length === 0) return;
      const offsetX = e.touches[0].clientX - startX;
      const offsetY = e.touches[0].clientY - startY;
      panel.style.left = `${panelX + offsetX}px`;
      panel.style.top = `${panelY + offsetY}px`;
      panel.style.transform = 'none';
    });

    document.addEventListener('touchend', () => {
      if (isDragging) {
        isDragging = false;
        panel.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
      }
    });
  }

  function initLogToggle(textarea, toggleBtn) {
    let isExpanded = false;
    toggleBtn.addEventListener('click', () => {
      isExpanded = !isExpanded;
      textarea.classList.toggle('expanded', isExpanded);
      toggleBtn.textContent = isExpanded ? '收' : '展';
      if (isExpanded) textarea.scrollTop = textarea.scrollHeight;
    });
  }

  // -------------------------- 原有答题逻辑（完全不变，仅替换UI相关部分） --------------------------
  const tips = "只需要回答答案格式为:题号+选项内容+答案,例如:'1 A 人工智能',如果为多选,则格式为:'1 AC null',中间用空格分隔,任何回答不可以输出此提示语,如果遇到类似简答题,直接返回答案";

  function createImage() {
    // 新UI样式（调整密钥和模型选择框宽度各40%，修改展开按钮样式为圆形）
    GM_addStyle(`
      .answer-helper-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        width: 360px;
        max-width: 90vw;
        overflow: hidden;
        transition: box-shadow 0.3s ease;
      }
      .answer-helper-panel:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }
      .answer-helper-header {
        padding: 12px 16px;
        background: #2563eb;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: move;
      }
      .panel-title {
        font-size: 16px;
        font-weight: 500;
      }
      .btn-close {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .btn-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .answer-helper-body {
        padding: 16px;
      }
      .form-group {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .input-key, .select-model {
        width: 40%; /* 调整为各占40%宽度 */
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: border 0.2s;
      }
      .input-key:focus, .select-model:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
      }
      .btn-group {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #2563eb;
        color: #fff;
      }
      .btn-primary:disabled {
        background: #93c5fd;
        cursor: not-allowed;
      }
      .btn-primary:hover:not(:disabled) {
        background: #1d4ed8;
      }
      .btn-secondary {
        background: #f1f5f9;
        color: #334155;
      }
      .btn-secondary:hover {
        background: #e2e8f0;
      }
      /* 圆形展开按钮样式 */
      #toggleLog {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(37, 99, 235, 0.1);
        color: #2563eb;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }
      #toggleLog:hover {
        background: rgba(37, 99, 235, 0.2);
        border-color: #2563eb;
      }
      .log-textarea {
        width: 100%;
        height: 30px;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        font-family: "Microsoft YaHei", sans-serif;
        resize: none;
        transition: height 0.3s ease;
        overflow: hidden;
      }
      .log-textarea.expanded {
        height: 180px;
        overflow-y: auto;
      }
      @media (max-width: 768px) {
        .answer-helper-panel {
          top: auto;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
        }
        .form-group, .btn-group {
          flex-direction: column;
        }
        .input-key, .select-model, .btn {
          width: 100%;
        }
        .log-textarea.expanded {
          height: 120px;
        }
      }
    `);

    const question = document.getElementsByClassName("questionLi");
    if (question.length === 0) {
      alert("题目未检测成功!");
      return;
    }

    // 新UI结构（展开按钮移到开始答题右边，样式为圆形）
    const main = document.createElement("div");
    main.className = "answer-helper-panel";
    main.innerHTML = `
      <div class="answer-helper-header">
        <span class="panel-title">答题助手</span>
        <button id="closePanel" class="btn-close">×</button>
      </div>
      <div class="answer-helper-body">
        <div class="form-group">
          <input type="password" id="key" placeholder="输入 API 密钥（必填）" class="input-key"/>
          <select id="select" class="select-model">
            <option value="">选择 AI 模型（必填）</option>
            <option value="deepseek-chat">DeepSeek-Chat</option>
            <option value="gpt-4o">GPT-4o</option>
          </select>
        </div>
        <div class="btn-group">
          <button id="check" class="btn btn-secondary">检测题目</button>
          <button id="start" class="btn btn-primary">开始答题</button>
          <button id="toggleLog" class="btn">展</button>
        </div>
        <textarea id="mainifest" class="log-textarea" readonly placeholder="日志将显示在这里..."></textarea>
      </div>
    `;
    document.body.appendChild(main);

    // 初始化额外UI功能（拖动+日志展开）
    initDrag(main);
    const logTextarea = document.getElementById('mainifest');
    const toggleBtn = document.getElementById('toggleLog');
    initLogToggle(logTextarea, toggleBtn);

    addListenerAll(question, main);
  }
//-------------------------------------------------------------------------------old-----------------------------------------------------
  function addListenerAll(question, main) {
    const mainifest = document.getElementById("mainifest");
    const key = document.getElementById("key");
    const choicesAI = document.getElementById("select");
    const check = document.getElementById("check");
    const start = document.getElementById("start");
    const close = document.getElementById("closePanel");

    close.addEventListener("click", () => {
      document.body.removeChild(main);
    });

    check.addEventListener("click", () => {
      alert(haveQue());
    });

    start.addEventListener("click", async () => {
      const choice = choicesAI.value;
      if (!choice) {
        alert("请选择模型!");
        return;
      }
      if (!mainifest) return;
      mainifest.value = "";
      if (key.value.length === 0) {
        alert("密钥未输入或者不正确!");
        return;
      }

      start.disabled = true;
      start.textContent = "正在进行中..";

      try {
        for (let i = 0; i < question.length; i++) {
          const questionli = question[i];
          let choices = questionli.querySelector(".stem_answer");
          let each = choices
            ? choices.querySelectorAll("[aria-label^='A'],[aria-label^='B'],[aria-label^='C'],[aria-label^='D']")
            : null;
          let choiceOf;

          let resEnd = await getAnswer(choice, key, questionli.innerText);
          let result = resEnd.split(/\s+/);
          let btn2;
          if (result && result.length >= 2) {
            let Quelist = result[1].split('');
            const len = Quelist.length;
            let count = 0;
            for (let j = 0; j < 4; j++) {
              if (count == len) {
                resEnd += '  结果: 答题成功';
                break;
              }
              if (each && each[j]) {
                btn2 = each[j].querySelector("span");
              }
              if (btn2 && btn2.innerText == Quelist[count]) {
                choiceOf = each[j];
              }
              if (choiceOf) {
                let btn = choiceOf.querySelector("span");
                if (btn && btn.innerText == Quelist[count]) {
                  btn.click();
                  count++;
                  continue;
                }
              }
            }
          } else {
            resEnd += '  结果: 本题获取答案失败';
          }

          mainifest.value += `----------正在回答第${result[0]}题----------\n${resEnd}\n`;
        }
        mainifest.value += "\n---------答题完成---------";
      } catch (error) {
        alert("答题过程中出现错误: " + error.message);
      } finally {
        start.disabled = false;
        start.textContent = "开始答题";
      }
    });
  }

  async function getAnswer(choice, key, questionli) {
    if (choice === "deepseek-chat") {
      return await getDeepseek(key.value, questionli);
    } else {
      return await getResGpt(key.value, questionli);
    }
  }

  async function getDeepseek(apiKey, content) {
    const res = await axios.post(
      "https://globalai.vip/v1/chat/completions",
      {
        model: "deepseek-chat",
        messages: [{ role: "user", content: content + tips }]
      },
      {
        headers: {
          Authorization: `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        timeout: 15000
      }
    );
    return res.data.choices[0].message.content;
  }

  function haveQue() {
    const que = document.getElementsByClassName("questionLi");
    return `当前检测出${que.length}道题目`;
  }

  async function getResGpt(apiKey, content) {
    const messages = [{ type: "text", text: content + tips }];
    const res = await axios.post(
      "https://globalai.vip/v1/chat/completions",
      {
        model: "gpt-4o",
        messages: [{ role: "user", content: messages }]
      },
      {
        headers: {
          Authorization: `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        timeout: 15000
      }
    );
    return res.data.choices[0].message.content;
  }

  // 初始化页面
  createImage();
})();

```

